<!DOCTYPE html>

<html lang="English">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Mosaic Integration (HT) &#8212; SpaMode 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b3523f8e" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=039e1c02" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js?v=15a40aba"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="RNA-ADT Vertical Integration (HLN)" href="../Vertical/RNA-ADT/SpaMode_HLN_A1.html" />
    <link rel="prev" title="Horizontal integration (Simulation)" href="../Horizontal/Sim_Horizon.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="Mosaic-Integration-(HT)">
<h1>Mosaic Integration (HT)<a class="headerlink" href="#Mosaic-Integration-(HT)" title="Permalink to this heading">¶</a></h1>
<p>config</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">SpaMode</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">anndata</span> <span class="k">as</span> <span class="nn">ad</span>
<span class="kn">import</span> <span class="nn">argparse</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">scanpy.pp</span> <span class="kn">import</span> <span class="n">combat</span>
<span class="kn">from</span> <span class="nn">SpaMode.preprocess</span> <span class="kn">import</span> <span class="n">clr_normalize_each_cell</span><span class="p">,</span> <span class="n">pca</span><span class="p">,</span> <span class="n">lsi</span>
<span class="kn">from</span> <span class="nn">SpaMode.preprocess</span> <span class="kn">import</span> <span class="n">construct_neighbor_graph</span>
<span class="kn">from</span> <span class="nn">SpaMode.utils</span> <span class="kn">import</span> <span class="n">clustering</span><span class="p">,</span> <span class="n">peak_sets_alignment</span><span class="p">,</span> <span class="n">gene_sets_alignment</span>
<span class="kn">from</span> <span class="nn">cal_matrics</span> <span class="kn">import</span> <span class="nb">eval</span>
<span class="kn">from</span> <span class="nn">SME.Svae</span> <span class="kn">import</span> <span class="n">Train_Smoe</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">coo_matrix</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">kneighbors_graph</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>

<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">NearestNeighbors</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="kn">from</span> <span class="nn">scipy.sparse.csgraph</span> <span class="kn">import</span> <span class="n">laplacian</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">procrustes</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_similarity</span>

<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sps</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">adjusted_rand_score</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">,</span> <span class="n">f1_score</span>
</pre></div>
</div>
</div>
<p>Data Process</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Environment configuration. SpatialGlue pacakge can be implemented with either CPU or GPU. GPU acceleration is highly recommend for imporoved efficiency.</span>
<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">binarize</span><span class="p">(</span><span class="n">Xs</span><span class="p">,</span> <span class="n">bin_thr</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">rs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">X</span> <span class="ow">in</span> <span class="n">Xs</span><span class="p">:</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">A</span><span class="p">)</span> <span class="k">if</span> <span class="n">sps</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="k">else</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">X</span><span class="o">&gt;</span><span class="n">bin_thr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">rs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rs</span>

<span class="k">def</span> <span class="nf">eval_AUC_all</span><span class="p">(</span><span class="n">gt_X</span><span class="p">,</span> <span class="n">pr_X</span><span class="p">,</span> <span class="n">bin_thr</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">gt_X</span> <span class="o">=</span> <span class="n">binarize</span><span class="p">([</span><span class="n">gt_X</span><span class="p">],</span> <span class="n">bin_thr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">pr_X</span> <span class="o">=</span> <span class="n">pr_X</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">auroc</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">gt_X</span><span class="p">,</span> <span class="n">pr_X</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">auroc</span>

<span class="k">def</span> <span class="nf">PCCs</span><span class="p">(</span><span class="n">gt_X</span><span class="p">,</span> <span class="n">pr_X</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_compute_pcc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">axis</span><span class="p">):</span>
        <span class="n">x_centered</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">y_centered</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_centered</span> <span class="o">*</span> <span class="n">y_centered</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="n">std_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x_centered</span>  <span class="o">**</span>  <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span>
        <span class="n">std_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">y_centered</span>  <span class="o">**</span>  <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">))</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="n">std_x</span> <span class="o">*</span> <span class="n">std_y</span>
        <span class="n">denom</span><span class="p">[</span><span class="n">denom</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">cov</span> <span class="o">/</span> <span class="n">denom</span>

    <span class="k">if</span> <span class="n">sps</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">gt_X</span><span class="p">):</span>
        <span class="n">gt_X</span> <span class="o">=</span> <span class="n">gt_X</span><span class="o">.</span><span class="n">A</span>
    <span class="k">if</span> <span class="n">sps</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">pr_X</span><span class="p">):</span>
        <span class="n">pr_X</span> <span class="o">=</span> <span class="n">pr_X</span><span class="o">.</span><span class="n">A</span>

    <span class="n">pcc_cell</span> <span class="o">=</span> <span class="n">_compute_pcc</span><span class="p">(</span><span class="n">gt_X</span><span class="p">,</span> <span class="n">pr_X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">pcc_cell</span><span class="p">,</span> <span class="mi">0</span>


<span class="k">def</span> <span class="nf">CMD</span><span class="p">(</span><span class="n">pr_X</span><span class="p">,</span> <span class="n">gt_X</span><span class="p">):</span>
    <span class="n">zero_mask</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">pr_X</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="o">~</span><span class="n">gt_X</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">rm_p</span> <span class="o">=</span> <span class="n">zero_mask</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rm_p</span> <span class="o">&gt;=</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: too many rows (</span><span class="si">{</span><span class="n">rm_p</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">%) with all zeros&#39;</span><span class="p">)</span>

    <span class="n">pr_array</span> <span class="o">=</span> <span class="n">pr_X</span><span class="p">[</span><span class="o">~</span><span class="n">zero_mask</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">gt_array</span> <span class="o">=</span> <span class="n">gt_X</span><span class="p">[</span><span class="o">~</span><span class="n">zero_mask</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fast_corr</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
        <span class="n">X_centered</span> <span class="o">=</span> <span class="n">X</span> <span class="o">-</span> <span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">X_centered</span> <span class="o">@</span> <span class="n">X_centered</span><span class="o">.</span><span class="n">T</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X_centered</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span> <span class="o">=</span> <span class="kc">True</span><span class="p">))</span>
        <span class="n">std</span><span class="p">[</span><span class="n">std</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">cov</span> <span class="o">/</span> <span class="p">(</span><span class="n">std</span> <span class="o">@</span> <span class="n">std</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="n">corr_pr</span> <span class="o">=</span> <span class="n">fast_corr</span><span class="p">(</span><span class="n">pr_array</span><span class="p">)</span>
    <span class="n">corr_gt</span> <span class="o">=</span> <span class="n">fast_corr</span><span class="p">(</span><span class="n">gt_array</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">corr_pr</span> <span class="o">*</span> <span class="n">corr_gt</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">corr_pr</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">corr_gt</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

    <span class="n">cmd</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span> <span class="o">/</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cmd</span>

<span class="k">def</span> <span class="nf">reconstruct_missing_modality</span><span class="p">(</span><span class="n">existing_m1_emb</span><span class="p">,</span> <span class="n">ref_m1_emb</span><span class="p">,</span> <span class="n">existing_m2</span><span class="p">,</span> <span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">recon_s2_m2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">imput_pca</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">existing_m1_emb</span> <span class="o">=</span> <span class="n">aggregate_neighborhood_features</span><span class="p">(</span><span class="n">existing_m1_emb</span><span class="p">,</span> <span class="n">A1</span><span class="p">)</span>
    <span class="n">ref_m1_emb</span> <span class="o">=</span> <span class="n">aggregate_neighborhood_features</span><span class="p">(</span><span class="n">ref_m1_emb</span><span class="p">,</span> <span class="n">A2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">imput_pca</span><span class="p">:</span>

        <span class="n">nn</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;brute&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">existing_m1_emb</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="n">ref_m1_emb</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">imput_m2</span> <span class="o">=</span> <span class="n">existing_m2</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

        <span class="n">imput_m1</span> <span class="o">=</span> <span class="n">existing_m1_emb</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

        <span class="n">erro</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">imput_m1</span><span class="p">,</span> <span class="n">ref_m1_emb</span><span class="p">))</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">erro</span> <span class="o">=</span> <span class="n">erro</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">imput_m2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">imput_m2</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">recon_s2_m2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">recon_s2_m2</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="n">imput</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">normalize</span><span class="p">(((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">erro</span><span class="p">)</span> <span class="o">*</span> <span class="n">imput_m2</span> <span class="o">+</span> <span class="n">erro</span> <span class="o">*</span> <span class="n">recon_s2_m2</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">K</span> <span class="o">=</span> <span class="mi">25</span>

        <span class="n">nn</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">K</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;brute&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">)</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">existing_m1_emb</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="n">ref_m1_emb</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sps</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">existing_m2</span><span class="p">):</span>
            <span class="n">indices_flat</span> <span class="o">=</span> <span class="n">indices</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">imput_m2</span> <span class="o">=</span> <span class="n">existing_m2</span><span class="p">[</span><span class="n">indices_flat</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
            <span class="n">imput_m2</span> <span class="o">=</span> <span class="n">imput_m2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">imput_m2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">imput_m2</span> <span class="o">=</span> <span class="n">existing_m2</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

        <span class="n">imput_m2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">imput_m2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">imput</span> <span class="o">=</span> <span class="n">imput_m2</span>

    <span class="k">return</span> <span class="n">imput</span><span class="p">,</span> <span class="n">existing_m1_emb</span><span class="p">,</span> <span class="n">ref_m1_emb</span>


<span class="k">def</span> <span class="nf">cosine_similarity</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="c1"># a, b: shape [..., D]</span>
    <span class="n">a_norm</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">b_norm</span> <span class="o">=</span> <span class="n">b</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a_norm</span> <span class="o">*</span> <span class="n">b_norm</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">aggregate_neighborhood_features</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">):</span>

    <span class="n">N</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">R_agg</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">A_sparse</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="n">neighbors</span> <span class="o">=</span> <span class="n">A_sparse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">indices</span>
        <span class="k">if</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
            <span class="n">feat</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="n">neighbors</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span>
            <span class="n">feat</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="n">neighbors</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">aggregation</span> <span class="o">==</span> <span class="s1">&#39;concat&#39;</span><span class="p">:</span>
            <span class="n">feat</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="n">neighbors</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">feat</span> <span class="o">=</span> <span class="n">feat</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span>
        <span class="n">R_agg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R_agg</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">data_preprocessing</span><span class="p">(</span><span class="n">adata_omics1</span><span class="p">,</span> <span class="n">adata_omics2</span><span class="p">):</span>

    <span class="n">adata_omics1</span><span class="o">.</span><span class="n">var_names_make_unique</span><span class="p">()</span>
    <span class="n">adata_omics2</span><span class="o">.</span><span class="n">var_names_make_unique</span><span class="p">()</span>

    <span class="c1"># RNA</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">highly_variable_genes</span><span class="p">(</span><span class="n">adata_omics1</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s2">&quot;seurat_v3&quot;</span><span class="p">,</span> <span class="n">n_top_genes</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_total</span><span class="p">(</span><span class="n">adata_omics1</span><span class="p">,</span> <span class="n">target_sum</span><span class="o">=</span><span class="mf">1e4</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">adata_omics1</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">adata_omics1</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="n">adata_omics1_high</span> <span class="o">=</span> <span class="n">adata_omics1</span><span class="p">[:,</span> <span class="n">adata_omics1</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;highly_variable&#39;</span><span class="p">]]</span>
    <span class="n">adata_omics1</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;feat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pca</span><span class="p">(</span><span class="n">adata_omics1_high</span><span class="p">,</span> <span class="n">n_comps</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

    <span class="c1"># Protein</span>
    <span class="n">adata_omics2</span> <span class="o">=</span> <span class="n">clr_normalize_each_cell</span><span class="p">(</span><span class="n">adata_omics2</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">scale</span><span class="p">(</span><span class="n">adata_omics2</span><span class="p">)</span>
    <span class="n">adata_omics2</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;feat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pca</span><span class="p">(</span><span class="n">adata_omics2</span><span class="p">,</span> <span class="n">n_comps</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">adata_omics1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">adata_omics2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">adata_omics1</span><span class="p">,</span> <span class="n">adata_omics2</span>
<br/><br/><br/><br/><br/></pre></div>
</div>
</div>
<p>Mosaic Integration</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><br/><span></span><span class="c1"># Fix random seed</span>
<span class="kn">from</span> <span class="nn">SME.preprocess</span> <span class="kn">import</span> <span class="n">fix_seed</span>
<span class="n">random_seed</span> <span class="o">=</span> <span class="mi">2025</span>
<span class="n">fix_seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>

<span class="n">file_paths</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;/root/autodl-tmp/Data/Human_tonsil/slice1/s1_adata_rna.h5ad&#39;</span><span class="p">,</span>
              <span class="s1">&#39;/root/autodl-tmp/Data/Human_tonsil/slice1/s1_adata_adt.h5ad&#39;</span><span class="p">],</span>
    <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;/root/autodl-tmp/Data/Human_tonsil/slice2/s2_adata_rna.h5ad&#39;</span><span class="p">,</span>
              <span class="s1">&#39;/root/autodl-tmp/Data/Human_tonsil/slice2/s2_adata_adt.h5ad&#39;</span><span class="p">],</span>
    <span class="s1">&#39;3&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;/root/autodl-tmp/Data/Human_tonsil/slice3/s3_adata_rna.h5ad&#39;</span><span class="p">,</span>
              <span class="s1">&#39;/root/autodl-tmp/Data/Human_tonsil/slice3/s3_adata_adt.h5ad&#39;</span><span class="p">],</span>
<span class="p">}</span>

<span class="n">GT_paths</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="s1">&#39;/root/autodl-tmp/0222/Results/HT/slice-1/HT-slice-1-GT.txt&#39;</span><span class="p">,</span>
    <span class="s1">&#39;2&#39;</span><span class="p">:</span> <span class="s1">&#39;/root/autodl-tmp/0222/Results/HT/slice-2/HT-slice-2-GT.txt&#39;</span><span class="p">,</span>
    <span class="s1">&#39;3&#39;</span><span class="p">:</span> <span class="s1">&#39;/root/autodl-tmp/0222/Results/HT/slice-3/HT-slice-3-GT.txt&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">adata_omics1</span><span class="p">,</span> <span class="n">adata_omics2</span> <span class="o">=</span> <span class="p">[</span><span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">]]</span>

<span class="n">adata_omics1_cp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">adata_omics1</span><span class="p">)</span>
<span class="n">adata_omics2_cp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">adata_omics2</span><span class="p">)</span>

<span class="n">adata_omics1</span><span class="p">,</span> <span class="n">adata_omics2</span> <span class="o">=</span> <span class="n">data_preprocessing</span><span class="p">(</span><span class="n">adata_omics1</span><span class="p">,</span> <span class="n">adata_omics2</span><span class="p">)</span>
<span class="n">adata</span> <span class="o">=</span> <span class="n">construct_neighbor_graph</span><span class="p">(</span><span class="n">adata_omics1</span><span class="p">,</span> <span class="n">adata_omics2</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;10x&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">json</span>
<span class="c1"># 加载配置文件</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/root/autodl-tmp/0222/config/cfg_training.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">SME.SpaMode_Mosaic</span> <span class="kn">import</span> <span class="n">Train_SpaMode</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Train_SpaMode</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;10x&#39;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">Arg</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;HT&quot;</span><span class="p">][</span><span class="s1">&#39;1&#39;</span><span class="p">])</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

<span class="n">adata_omics1</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;Smoe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;Smoe&#39;</span><span class="p">]</span>

<span class="c1"># Imputation S2_ADT</span>
<span class="n">adata_omics1_E15</span><span class="p">,</span> <span class="n">adata_omics2_E15</span> <span class="o">=</span> <span class="p">[</span><span class="n">sc</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">]]</span>

<span class="n">adata_omics2_E15_cp</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">adata_omics2_E15</span><span class="p">)</span>

<span class="n">adata_omics1_E15</span><span class="p">,</span> <span class="n">adata_omics2_E15</span> <span class="o">=</span> <span class="n">data_preprocessing</span><span class="p">(</span><span class="n">adata_omics1_E15</span><span class="p">,</span> <span class="n">adata_omics2_E15</span><span class="p">)</span>
<span class="n">adata_E15</span> <span class="o">=</span> <span class="n">construct_neighbor_graph</span><span class="p">(</span><span class="n">adata_omics1_E15</span><span class="p">,</span> <span class="n">adata_omics1_E15</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;10x&#39;</span><span class="p">)</span>
<span class="n">infer_results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">imputation</span><span class="p">(</span><span class="n">adata_E15</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">imput_adt_pca</span><span class="p">,</span> <span class="n">adata_omics1_spatial_smooth</span><span class="p">,</span> <span class="n">adata_omics1_E15_spatial_smooth</span> <span class="o">=</span> <span class="n">reconstruct_missing_modality</span><span class="p">(</span>
        <span class="n">adata_omics1</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;feat&#39;</span><span class="p">],</span>
        <span class="n">adata_omics1_E15</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;feat&#39;</span><span class="p">],</span>
        <span class="n">adata_omics2</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;feat&#39;</span><span class="p">],</span>
        <span class="n">model</span><span class="o">.</span><span class="n">adj_spatial_omics1</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">tmp_adj_spatial_omics1</span><span class="p">,</span>
        <span class="n">F</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span>
            <span class="n">infer_results</span><span class="p">[</span><span class="s1">&#39;emb_recon_omics2&#39;</span><span class="p">],</span>
            <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">imput_pca</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

<span class="n">adata_omics2_E15</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;feat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imput_adt_pca</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

<span class="n">adata_E15_imput</span> <span class="o">=</span> <span class="n">construct_neighbor_graph</span><span class="p">(</span><span class="n">adata_omics1_E15</span><span class="p">,</span> <span class="n">adata_omics2_E15</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;10x&#39;</span><span class="p">)</span>
<span class="n">model_mosaic</span> <span class="o">=</span> <span class="n">Train_SpaMode</span><span class="p">(</span><span class="n">adata_E15_imput</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="s1">&#39;10x&#39;</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">Arg</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;HT&quot;</span><span class="p">][</span><span class="s1">&#39;2&#39;</span><span class="p">])</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">model_mosaic</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="n">adata_omics1_E15</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;Smoe&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;Smoe&#39;</span><span class="p">]</span>
<span class="c1"># adata_omics1_E15.write_h5ad(&#39;/root/autodl-tmp/0222/Results/HT/Mosaic/Our/Slice_2.h5ad&#39;)</span>
<br/><br/><br/><br/><br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 4326 × 18085
    obs: &#39;lab&#39;, &#39;lab_lynn&#39;, &#39;src&#39;, &#39;final_annot&#39;
    var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;genome&#39;, &#39;highly_variable&#39;, &#39;highly_variable_rank&#39;, &#39;means&#39;, &#39;variances&#39;, &#39;variances_norm&#39;, &#39;mean&#39;, &#39;std&#39;
    uns: &#39;hvg&#39;, &#39;log1p&#39;
    obsm: &#39;spatial&#39;, &#39;feat&#39;
AnnData object with n_obs × n_vars = 4326 × 31
    obs: &#39;lab&#39;, &#39;lab_lynn&#39;, &#39;src&#39;, &#39;final_annot&#39;
    var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;genome&#39;, &#39;mean&#39;, &#39;std&#39;
    obsm: &#39;spatial&#39;, &#39;feat&#39;
Spatial_neighbors = 3
Feature_neighbors = 20
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/root/autodl-tmp/SpaMode_0903/SME/Svae_0318.py:104: UserWarning: Implicit dimension choice for softmax has been deprecated. Change the call to include dim=X as an argument.
  weight = F.softmax(differ_stack)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0.8057, 0.5797], device=&#39;cuda:0&#39;) tensor([0.5563, 0.4437], device=&#39;cuda:0&#39;)
optimizer:  SGD
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
 51%|█████     | 509/1000 [01:55&lt;01:51,  4.41it/s, Biloss=0.191, adv_loss=0.271, kl_loss=0.897, moe_loss=0.0202, recon=18.6]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Early Stop
Model training finished!

AnnData object with n_obs × n_vars = 4519 × 18085
    obs: &#39;lab&#39;, &#39;src&#39;, &#39;final_annot&#39;
    var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;genome&#39;, &#39;highly_variable&#39;, &#39;highly_variable_rank&#39;, &#39;means&#39;, &#39;variances&#39;, &#39;variances_norm&#39;, &#39;mean&#39;, &#39;std&#39;
    uns: &#39;hvg&#39;, &#39;log1p&#39;
    obsm: &#39;spatial&#39;, &#39;feat&#39;
AnnData object with n_obs × n_vars = 4519 × 31
    obs: &#39;lab&#39;, &#39;src&#39;, &#39;final_annot&#39;
    var: &#39;gene_ids&#39;, &#39;feature_types&#39;, &#39;genome&#39;, &#39;mean&#39;, &#39;std&#39;
    obsm: &#39;spatial&#39;, &#39;feat&#39;
Spatial_neighbors = 3
Feature_neighbors = 20
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/root/autodl-tmp/SpaMode_0903/SME/Svae_0318.py:296: UserWarning: Implicit dimension choice for softmax has been deprecated. Change the call to include dim=X as an argument.
  weight = F.softmax(differ_stack)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([1.0000, 1.0000], device=&#39;cuda:0&#39;) tensor([0.5000, 0.5000], device=&#39;cuda:0&#39;)
torch.Size([4519, 4519, 64]) torch.Size([4519, 4519, 64])
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_7187/2397127696.py:84: UserWarning: To copy construct from a tensor, it is recommended to use sourceTensor.clone().detach() or sourceTensor.clone().detach().requires_grad_(True), rather than torch.tensor(sourceTensor).
  recon_s2_m2 = torch.tensor(recon_s2_m2).cuda()
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Spatial_neighbors = 3
Feature_neighbors = 20
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/root/autodl-tmp/SpaMode_0903/SME/Svae_0318.py:104: UserWarning: Implicit dimension choice for softmax has been deprecated. Change the call to include dim=X as an argument.
  weight = F.softmax(differ_stack)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
tensor([0.7120, 0.8796], device=&#39;cuda:0&#39;) tensor([0.4582, 0.5418], device=&#39;cuda:0&#39;)
optimizer:  SGD
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
 55%|█████▍    | 549/1000 [02:21&lt;01:56,  3.87it/s, Biloss=0.166, adv_loss=0.245, kl_loss=0.864, moe_loss=0.00209, recon=12.5]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Early Stop
Model training finished!

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<p>Imputation</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="n">mix_omics1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">adata_omics1</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;feat&#39;</span><span class="p">],</span> <span class="n">adata_omics2</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;feat&#39;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">mix_omics2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">adata_omics1_E15</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;feat&#39;</span><span class="p">],</span> <span class="n">adata_omics2_E15</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;feat&#39;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">imput_adt_raw</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">reconstruct_missing_modality</span><span class="p">(</span>
        <span class="n">mix_omics1</span><span class="p">,</span>
        <span class="n">mix_omics2</span><span class="p">,</span>
        <span class="n">adata_omics2_cp</span><span class="o">.</span><span class="n">X</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">adj_spatial_omics1</span><span class="p">,</span>
        <span class="n">model</span><span class="o">.</span><span class="n">tmp_adj_spatial_omics1</span><span class="p">,</span>
<span class="p">)</span>


<span class="n">adata_omics2_E15_imputed</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">adata_omics2_E15_cp</span><span class="p">)</span>
<span class="n">adata_omics2_E15_imputed</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">(</span><span class="n">imput_adt_raw</span><span class="p">)</span>
<span class="n">adata_omics2_E15_imputed</span><span class="o">.</span><span class="n">write_h5ad</span><span class="p">(</span><span class="s1">&#39;/root/autodl-tmp/0222/Results/HT/Imput/HT_S2_ADT_imput_our.h5ad&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------Eval Imput ADT------------------&quot;</span><span class="p">)</span>

<span class="n">gt_X</span> <span class="o">=</span> <span class="n">adata_omics2_E15_cp</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
<span class="n">pr_X</span> <span class="o">=</span> <span class="n">imput_adt_raw</span>

<span class="n">pcc_cell</span><span class="p">,</span> <span class="n">pcc_adt</span> <span class="o">=</span> <span class="n">PCCs</span><span class="p">(</span><span class="n">gt_X</span><span class="p">,</span> <span class="n">pr_X</span><span class="p">)</span>

<span class="n">cmd_cell</span> <span class="o">=</span> <span class="n">CMD</span><span class="p">(</span><span class="n">pr_X</span><span class="p">,</span> <span class="n">gt_X</span><span class="p">)</span>
<span class="n">cmd_adt</span> <span class="o">=</span> <span class="n">CMD</span><span class="p">(</span><span class="n">pr_X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">gt_X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PCC cell:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pcc_cell</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;PCC RNA:&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pcc_adt</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Command cell:&#39;</span><span class="p">,</span> <span class="n">cmd_cell</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Command RNA:&#39;</span><span class="p">,</span> <span class="n">cmd_adt</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------Eval Imput ADT------------------&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
-----------------Eval Imput ADT------------------
PCC cell: 0.93754214
PCC RNA: 0.0
Command cell: 0.010368214880204674
Command RNA: 0.22684393721285268
-----------------Eval Imput ADT------------------
</pre></div></div>
</div>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">SpaMode</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Horizontal/Sim_Horizon.html">Horizontal integration (Simulation)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Mosaic Integration (HT)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Vertical/RNA-ADT/SpaMode_HLN_A1.html">RNA-ADT Vertical Integration (HLN)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Vertical/RNA-ATAC/SpaMode_MISAR_E13.html">RNA-ATAC Vertical Integration (Mouse Embryo E11.0)</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="../Horizontal/Sim_Horizon.html" title="previous chapter">Horizontal integration (Simulation)</a></li>
      <li>Next: <a href="../Vertical/RNA-ADT/SpaMode_HLN_A1.html" title="next chapter">RNA-ADT Vertical Integration (HLN)</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2025, Xinlei Huang.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.13</a>
      
      |
      <a href="../../_sources/Examples/Mosaic/SpaMode_Mosaic_HT.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>